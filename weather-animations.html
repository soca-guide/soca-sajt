<!doctype html>
<html lang="sr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cinematic Weather</title>
  <style>
    /* --- PURE CINEMATIC STYLE --- */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100vh;
      width: 100vw;
    }

    /* Glavni kontejner koji drži sve layere */
    #scene-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0; /* Počinje crno */
      transition: opacity 2s ease-in-out;
    }

    /* VINJETA - Daje filmski izgled (tamni uglovi) */
    .vignette {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.4) 100%);
      z-index: 100;
      pointer-events: none;
    }

    /* CANVAS ZA PADAVINE (Najbolje performanse) */
    #particleCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 50;
      pointer-events: none;
    }

    /* POZADINSKI GRADIJENTI (Skybox) */
    .sky-layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      transition: opacity 2s ease-in-out;
      opacity: 0;
      z-index: 1;
    }
    .sky-layer.active { opacity: 1; }

    /* DEFINICIJE BOJA NEBA (Dublje, modernije boje) */
    .sky-sunny { background: linear-gradient(to bottom, #1E90FF 0%, #87CEFA 100%); }
    .sky-cloudy { background: linear-gradient(to bottom, #5D6D7E 0%, #BFC9CA 100%); }
    .sky-rain { background: linear-gradient(to bottom, #2C3E50 0%, #4A5868 100%); }
    .sky-storm { background: linear-gradient(to bottom, #17202A 0%, #283747 100%); }
    .sky-snow { background: linear-gradient(to bottom, #85929E 0%, #D6EAF8 100%); }
    
    /* NOĆNE VARIJANTE */
    .sky-clear-night { background: linear-gradient(to bottom, #020111 0%, #191629 100%); }
    .sky-cloudy-night { background: linear-gradient(to bottom, #111 0%, #2c3e50 100%); }

    /* CELESTIAL BODIES - moon z-index:1, behind clouds; moved right for contrast (Step 1) */
    .celestial-container {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 10;
      pointer-events: none;
    }

    .sun {
      position: absolute;
      top: 8%; right: 8%;
      width: 100px; height: 100px;
      background: #FFD700;
      border-radius: 50%;
      box-shadow: 0 0 80px rgba(255, 215, 0, 0.8), 0 0 150px rgba(255, 140, 0, 0.4);
      opacity: 0;
      transition: opacity 2s, transform 10s ease-out;
      transform: translateY(20px);
    }
    
    .moon {
      position: absolute;
      top: 12%; right: 2%;
      width: 80px; height: 80px;
      background: #FDFEFE;
      border-radius: 50%;
      box-shadow: 0 0 40px rgba(255, 255, 255, 0.6), 0 0 100px rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 2s, clip-path 1s ease;
      z-index: 1;
    }
    .moon.phase-new { clip-path: circle(2% at 50% 50%); }
    .moon.phase-new.visible { opacity: 0.25 !important; }
    .moon.phase-crescent-waxing { clip-path: ellipse(50% 50% at 85% 50%); }
    .moon.phase-quarter-first { clip-path: ellipse(50% 50% at 100% 50%); }
    .moon.phase-gibbous-waxing { clip-path: ellipse(50% 50% at 92% 50%); }
    .moon.phase-full { clip-path: circle(50% at 50% 50%); }
    .moon.phase-gibbous-waning { clip-path: ellipse(50% 50% at 8% 50%); }
    .moon.phase-quarter-last { clip-path: ellipse(50% 50% at 0% 50%); }
    .moon.phase-crescent-waning { clip-path: ellipse(50% 50% at 15% 50%); }

    .visible { opacity: 1 !important; transform: translateY(0) !important; }

    /* OBLACI (Mekani, proceduralni) */
    .clouds-layer {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 20;
      opacity: 0;
      transition: opacity 2s;
      filter: blur(3px); /* Filmski blur za dubinu */
    }
    .clouds-layer.active { opacity: 1; }

    .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 100px;
      animation: float 60s linear infinite;
    }
    .night-cloud { background: rgba(149, 165, 166, 0.2); }

    @keyframes float {
      from { transform: translateX(-150%); }
      to { transform: translateX(150vw); }
    }

    /* MUNJA (Flash) */
    .lightning-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #fff;
      opacity: 0;
      z-index: 90;
      mix-blend-mode: overlay;
    }

  </style>
 </head>
 <body>

  <div id="scene-container">
    
    <div class="vignette"></div>

    <canvas id="particleCanvas"></canvas>

    <div id="sky-sunny" class="sky-layer sky-sunny"></div>
    <div id="sky-cloudy" class="sky-layer sky-cloudy"></div>
    <div id="sky-rain" class="sky-layer sky-rain"></div>
    <div id="sky-storm" class="sky-layer sky-storm"></div>
    <div id="sky-snow" class="sky-layer sky-snow"></div>
    <div id="sky-clear-night" class="sky-layer sky-clear-night"></div>
    <div id="sky-cloudy-night" class="sky-layer sky-cloudy-night"></div>

    <div class="celestial-container">
      <div id="theSun" class="sun"></div>
      <div id="theMoon" class="moon"></div>
    </div>

    <div id="clouds-white" class="clouds-layer"></div>
    <div id="clouds-dark" class="clouds-layer"></div>

    <div id="flash" class="lightning-overlay"></div>

  </div>

  <script>
    // --- SETUP CANVAS-A (VISOKE PERFORMANSE) ---
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    let particles = [];
    let state = { type: 'clean', isNight: false, moonPhaseClass: null };

    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- LOGIKA ČESTICA ---
    class Particle {
      constructor(type) {
        this.type = type;
        this.reset();
      }
      reset() {
        this.x = Math.random() * width;
        this.y = Math.random() * -height;
        
        if (this.type === 'rain') {
          this.speed = Math.random() * 15 + 20; // Brža kiša
          this.len = Math.random() * 20 + 10;
          this.opacity = Math.random() * 0.3 + 0.1;
        } else if (this.type === 'snow') {
          this.speed = Math.random() * 2 + 1;
          this.size = Math.random() * 3 + 1;
          this.swing = Math.random() * 2; 
          this.step = Math.random() * Math.PI;
        } else if (this.type === 'star') {
          this.x = Math.random() * width;
          this.y = Math.random() * height * 0.6; // Samo gornji deo
          this.size = Math.random() * 1.5;
          this.opacity = Math.random();
          this.speed = 0; // Zvezde stoje
        }
      }
      update() {
        if (this.type === 'star') {
          this.opacity += (Math.random() - 0.5) * 0.05; // Treperenje
          if(this.opacity < 0) this.opacity = 0;
          if(this.opacity > 1) this.opacity = 1;
          return;
        }

        this.y += this.speed;
        if (this.type === 'snow') {
          this.step += 0.02;
          this.x += Math.sin(this.step) * this.swing;
        }

        if (this.y > height) this.reset();
      }
      draw() {
        ctx.beginPath();
        if (this.type === 'rain') {
          ctx.strokeStyle = `rgba(200, 210, 255, ${this.opacity})`;
          ctx.lineWidth = 1;
          ctx.moveTo(this.x, this.y);
          ctx.lineTo(this.x - 2, this.y + this.len); // Kosa kiša (vetar)
          ctx.stroke();
        } else if (this.type === 'snow') {
          ctx.fillStyle = `rgba(255, 255, 255, 0.8)`;
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        } else if (this.type === 'star') {
          ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    function initParticles(type) {
      particles = [];
      let count = 0;
      if (type === 'rain' || type === 'storm') count = 800; // Gusta kiša
      if (type === 'snow') count = 200;
      if (type === 'clear' && state.isNight) count = 200; // Zvezde

      for(let i=0; i<count; i++) {
        let pType = (type === 'clear' && state.isNight) ? 'star' : (type === 'snow' ? 'snow' : 'rain');
        particles.push(new Particle(pType));
      }
    }

    function loop() {
      ctx.clearRect(0, 0, width, height);
      particles.forEach(p => { p.update(); p.draw(); });
      
      // Random munje
      if (state.type === 'storm' && Math.random() > 0.99) {
        triggerLightning();
      }
      
      requestAnimationFrame(loop);
    }
    loop();

    function triggerLightning() {
      const flash = document.getElementById('flash');
      flash.style.opacity = 0.6;
      setTimeout(() => { flash.style.opacity = 0; }, 80);
      setTimeout(() => { 
        flash.style.opacity = 0.3; 
        setTimeout(() => { flash.style.opacity = 0; }, 50);
      }, 150);
    }

    // --- OBLACI ---
    function createClouds(isDark) {
      const container = document.getElementById(isDark ? 'clouds-dark' : 'clouds-white');
      container.innerHTML = '';
      const count = isDark ? 10 : 6;
      
      for(let i=0; i<count; i++) {
        const c = document.createElement('div');
        c.className = isDark ? 'cloud night-cloud' : 'cloud';
        const w = Math.random() * 400 + 200;
        c.style.width = w + 'px';
        c.style.height = (w * 0.35) + 'px';
        c.style.top = (Math.random() * 50) + '%';
        c.style.left = (Math.random() * 100) + '%';
        c.style.opacity = Math.random() * 0.4 + 0.3;
        c.style.animationDuration = (Math.random() * 60 + 40) + 's';
        c.style.filter = "blur(8px)"; // Još mekši oblaci
        container.appendChild(c);
      }
    }

    // --- MOON PHASE: API first, fallback to date calculation (Step 2) ---
    function moonPhaseToClass(phase) {
      if (phase == null || phase < 0) return getMoonPhaseName();
      if (phase < 0.03 || phase > 0.97) return 'phase-new';
      if (phase < 0.22) return 'phase-crescent-waxing';
      if (phase < 0.28) return 'phase-quarter-first';
      if (phase < 0.47) return 'phase-gibbous-waxing';
      if (phase < 0.53) return 'phase-full';
      if (phase < 0.72) return 'phase-gibbous-waning';
      if (phase < 0.78) return 'phase-quarter-last';
      return 'phase-crescent-waning';
    }
    function getMoonPhaseName() {
      const knownNewMoon = new Date(2000, 0, 6, 18, 14).getTime();
      const lunarCycle = 29.53058867 * 24 * 60 * 60 * 1000;
      const now = Date.now();
      const days = (now - knownNewMoon) / (24 * 60 * 60 * 1000);
      const phase = (days % 29.53058867) / 29.53058867; // 0-1
      if (phase < 0.03 || phase > 0.97) return 'phase-new';
      if (phase < 0.22) return 'phase-crescent-waxing';
      if (phase < 0.28) return 'phase-quarter-first';
      if (phase < 0.47) return 'phase-gibbous-waxing';
      if (phase < 0.53) return 'phase-full';
      if (phase < 0.72) return 'phase-gibbous-waning';
      if (phase < 0.78) return 'phase-quarter-last';
      return 'phase-crescent-waning';
    }

    // --- LOGIKA VREMENA: lokalno vreme kao izvor (API is_day može grešiti) ---
    function isLocalNight() {
      const hour = new Date().getHours();
      return hour >= 21 || hour < 6; // 21:00–06:00 = noć (SLO/CET)
    }
    function setScene(code, isDay) {
      const isNight = isLocalNight();
      state.isNight = isNight;

      // Reset
      document.querySelectorAll('.sky-layer').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.clouds-layer').forEach(el => el.classList.remove('active'));
      document.getElementById('theSun').classList.remove('visible');
      const moonEl = document.getElementById('theMoon');
      moonEl.classList.remove('visible');
      moonEl.classList.remove('phase-new','phase-crescent-waxing','phase-quarter-first','phase-gibbous-waxing','phase-full','phase-gibbous-waning','phase-quarter-last','phase-crescent-waning');
      if (!isNight) moonEl.style.display = 'none';

      let type = 'clear';
      let bgId = isNight ? 'sky-clear-night' : 'sky-sunny';
      let showClouds = false;
      let darkClouds = false;

      // Mapiranje kodova
      if (code >= 95) { // Oluja
        type = 'storm';
        bgId = 'sky-storm';
        showClouds = true;
        darkClouds = true;
      } else if (code >= 71 || code === 85 || code === 86) { // Sneg
        type = 'snow';
        bgId = isNight ? 'sky-cloudy-night' : 'sky-snow';
      } else if (code >= 51 || code === 80 || code === 81 || code === 82) { // Kiša
        type = 'rain';
        bgId = 'sky-rain';
        showClouds = true;
        darkClouds = true;
      } else if (code >= 1 && code <= 3) { // Oblačno
        type = 'cloudy';
        bgId = isNight ? 'sky-cloudy-night' : 'sky-cloudy';
        showClouds = true;
        darkClouds = isNight;
      } else if (code === 45 || code === 48) { // Magla
        type = 'cloudy'; // Tretiramo kao oblačno vizuelno
        bgId = 'sky-cloudy';
        showClouds = true;
      }

      state.type = type;

      // 1. Postavi pozadinu
      document.getElementById(bgId).classList.add('active');

      // 2. Nebeska tela - sunce danju, mesec SAMO noću (Step 3: is_day===0)
      if (type === 'clear' || type === 'cloudy') {
        if (!isNight) {
          document.getElementById('theSun').classList.add('visible');
          moonEl.style.display = 'none';
        } else {
          moonEl.style.display = '';
          moonEl.classList.add(state.moonPhaseClass || getMoonPhaseName());
          moonEl.classList.add('visible');
        }
      }

      // 3. Oblaci
      if (showClouds) {
        const cloudId = darkClouds ? 'clouds-dark' : 'clouds-white';
        createClouds(darkClouds);
        document.getElementById(cloudId).classList.add('active');
      }

      // 4. Čestice
      initParticles(type);

      // Fade In Scene
      document.getElementById('scene-container').style.opacity = 1;
    }

    // --- FETCH DATA (Step 2: moon_phase from Forecast API - single request) ---
    async function getWeather(lat, lon) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.current) {
          state.moonPhaseClass = null;
          setScene(0, 1);
          return;
        }
        let moonPhase = null;
        if (data.daily && data.daily.moon_phase && data.daily.moon_phase[0] != null) {
          moonPhase = data.daily.moon_phase[0];
        }
        state.moonPhaseClass = moonPhase != null ? moonPhaseToClass(moonPhase) : null;
        setScene(data.current.weather_code, data.current.is_day);
      } catch (e) {
        console.error(e);
        state.moonPhaseClass = null;
        setScene(0, 1);
      }
    }

    // --- POKRETANJE (cache + deny flag, no geolocation spam) ---
    const GEO_KEY = 'wx_geo_v1';
    const DENY_KEY = 'wx_geo_denied_v1';
    const TTL_MS = 6 * 60 * 60 * 1000;
    const DEFAULT_LAT = 44.7866, DEFAULT_LON = 20.4489;

    function startup() {
      try {
        if (sessionStorage.getItem(DENY_KEY)) {
          getWeather(DEFAULT_LAT, DEFAULT_LON);
          return;
        }
        const raw = localStorage.getItem(GEO_KEY);
        if (raw) {
          const o = JSON.parse(raw);
          if (o && typeof o.lat === 'number' && typeof o.lon === 'number' && (Date.now() - (o.ts || 0)) < TTL_MS) {
            getWeather(o.lat, o.lon);
            return;
          }
        }
      } catch (e) {}
      if (!("geolocation" in navigator)) {
        getWeather(DEFAULT_LAT, DEFAULT_LON);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          try {
            localStorage.setItem(GEO_KEY, JSON.stringify({ lat: pos.coords.latitude, lon: pos.coords.longitude, ts: Date.now() }));
          } catch (e) {}
          getWeather(pos.coords.latitude, pos.coords.longitude);
        },
        () => {
          try { sessionStorage.setItem(DENY_KEY, '1'); } catch (e) {}
          getWeather(DEFAULT_LAT, DEFAULT_LON);
        }
      );
    }
    startup();
    window.addEventListener('pageshow', function(e) { if (e.persisted) startup(); });

  </script>
 </body>
</html>